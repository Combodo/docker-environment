ARG IMAGE=php:8.2-fpm
ARG XDEBUG_VERSION=3.5

FROM ${IMAGE}

ARG XDEBUG_VERSION
ARG UID=1000
ARG GID=1000

RUN usermod -u ${UID} www-data && groupmod -g ${GID} www-data

# Install @procps for "ps" & "pgrep" commands
RUN apt-get update && apt-get install -y procps

# Install @mariadb-client & @graphviz
RUN apt-get update && apt-get install mariadb-client graphviz -y

# install php extensions
COPY --from=ghcr.io/mlocati/php-extension-installer /usr/bin/install-php-extensions /usr/local/bin/

RUN install-php-extensions gd xdebug apcu imap mysqli soap zip ldap

RUN set -eux; \
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" && \
    php -r "if (hash_file('sha384', 'composer-setup.php') === 'c8b085408188070d5f52bcfe4ecfbee5f727afa458b2573b8eaaf77b3419b0bf2768dc67c86944da1544f06fa544fd47') { echo 'Installer verified'.PHP_EOL; } else { echo 'Installer corrupt'.PHP_EOL; unlink('composer-setup.php'); exit(1); }" && \
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer && \
    php -r "unlink('composer-setup.php');"

# Install @msmtp
RUN apt-get update && apt-get install -y --no-install-recommends msmtp ca-certificates \
    && rm -rf /var/lib/apt/lists/*

COPY default_configuration/msmtprc/msmtprc /var/www/.msmtprc
RUN chown www-data:www-data /var/www/.msmtprc \
&& chmod 600 /var/www/.msmtprc